# éš¾é¢˜:å¯¼è‡´å·¥å…·æ ä¸Šç‰‡æ®µå †æ ˆå¼¹å‡ºé—®é¢˜çš„åŸå› 

> åŸæ–‡ (Medium)ï¼š[Puzzle: Fragment stack pop cause issue on toolbar](https://medium.com/@elye.project/puzzle-fragment-stack-pop-cause-issue-on-toolbar-8b947c5c07c6)
>
> ä½œè€…ï¼š[Elye](https://medium.com/@elye.project?source=post_header_lockup)

[TOC]

ä½¿ç”¨ç‰‡æ®µï¼Œä½¿ç”¨å·¥å…·æ æ˜¯éå¸¸æ™®éçš„ï¼Œè€Œä¸”ç›´åˆ°è¿™ä¸ªæ˜ŸæœŸä¹‹å‰æˆ‘éƒ½ä¸æœŸæœ›æ‰¾åˆ°ä»»ä½•é—®é¢˜ã€‚æˆ‘é¢å¯¹è¿™ä¸ªçœ‹ä¼¼å¥‡æ€ªçš„é—®é¢˜ï¼Œå‘ç°å®ƒçš„åŸå› èŠ±äº†æˆ‘å¤§çº¦2å¤©ã€‚å¦‚æœä½ æ›¾ç»çœ‹åˆ°è¿‡è¿™æ ·çš„è¡Œä¸ºï¼Œåˆ†äº«è¿™äº›ä¿¡æ¯å¯ä»¥è®©ä½ æ›´æ—©åœ°äº†è§£å®ƒã€‚ 

å¦å¤–æˆ‘è¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„è°œé¢˜ä¾›ä½ è§£å†³ğŸ˜‰ã€‚

## èƒŒæ™¯

æˆ‘æœ‰ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œåœ¨æ´»åŠ¨ä¸­æœ‰ä¸€ä¸ªå¸ƒå±€å®¹å™¨ã€‚å®¹å™¨å æ®äº†æ•´ä¸ªæ´»åŠ¨çš„å®½åº¦ï¼Œå¹¶ä¸”å®ƒè¢«ç‰‡æ®µæˆ–ä¸€ç»„ç‰‡æ®µå……æ»¡ã€‚

![](https://ws4.sinaimg.cn/large/006tKfTcgy1frowjxzih6j30dc09qaaf.jpg)

## åœ¨æ¯ä¸ªç‰‡æ®µä¸­è®¾ç½®å·¥å…·æ 

åœ¨æˆ‘çš„åº”ç”¨ç¨‹åºä¸­ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½æœ‰å®ƒä»¬å„è‡ªçš„å·¥å…·æ å’Œå®ƒçš„èœå•ã€‚ç”±äºæ²¡æœ‰é€šç”¨çš„å·¥å…·æ ï¼Œå› æ­¤å®ƒè¢«è®¾ç½®åœ¨ç‰‡æ®µä¸­è€Œä¸æ˜¯æ´»åŠ¨ä¸­ã€‚ä»£ç å¦‚ä¸‹ã€‚

```kotlin
(activity as AppCompatActivity).setSupportActionBar(toolbar)
```

åœ¨æˆ‘çš„æ‰€æœ‰å·¥å…·æ ä¸­ï¼Œæˆ‘éƒ½æœ‰ä¸€ä¸ªå·¥å…·èœå•ï¼Œå¯ä»¥è®©ä½ ç‚¹å‡»ã€‚

```kotlin
override fun onOptionsItemSelected(item: MenuItem): Boolean {
    if (item.itemId == android.R.id.home) {
        activity?.onBackPressed()
        return true
    } else {
        // Do some other things to other menu
        return super.onOptionsItemSelected(item)
    }
}
```

åœ¨æˆ‘çš„æ´»åŠ¨ä¸­ï¼Œ onBackPressed ( ) å¼¹å‡ºç‰‡æ®µã€‚

```kotlin
override fun onBackPressed() {
    if (supportFragmentManager.backStackEntryCount > 0) {
        supportFragmentManager.popBackStackImmediate()
    } else {
        super.onBackPressed()
    }
}
```

## æ·»åŠ å’Œæ›¿æ¢ç‰‡æ®µæ··åˆä½¿ç”¨

æ­¤å¤–ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä½¿ç”¨ replace å°†æˆ‘çš„ç‰‡æ®µæ·»åŠ åˆ°å †æ ˆï¼Œæœ‰æ—¶æˆ‘ä½¿ç”¨ add å°†æˆ‘çš„ç‰‡æ®µæ·»åŠ åˆ°å †æ ˆã€‚

```kotlin
private fun addFragment(fragment: Fragment, name: String) {
    supportFragmentManager.beginTransaction()
            .add(R.id.container, fragment, name)
            .addToBackStack(name).commit()
}

private fun replaceFragment(fragment: Fragment, name: String) {
    supportFragmentManager.beginTransaction()
            .replace(R.id.container, fragment, name)
            .addToBackStack(name).commit()
}
```

> æ³¨æ„ï¼šä½¿ç”¨æ›¿æ¢ç‰‡æ®µä¼˜äºä½¿ç”¨æ·»åŠ ï¼Œå› ä¸ºå®ƒä¸ä¼šåœ¨å†…å­˜ä¸­å­˜å‚¨ä¸å¿…è¦çš„ç‰‡æ®µï¼Œå¹¶ä¸”è¿˜å‡å°‘äº† UI æ¸²æŸ“éœ€æ±‚ã€‚ä½†æ˜¯ï¼Œå¦‚æœå½“å‰ç‰‡æ®µåŒ…å« webviewï¼Œè¦æ‰“å¼€ä¸‹ä¸€ä¸ªç‰‡æ®µï¼Œåˆ™ä½¿ç”¨ add æ›´å¥½ï¼Œå½“ä½ å¼¹å‡ºé‚£ä¸ª"ä¸‹ä¸€ä¸ª"ç‰‡æ®µæ—¶ï¼Œä½ ç°æœ‰çš„å¸¦æœ‰ webview çš„ç‰‡æ®µæ˜¯ä¿ç•™çš„ï¼Œä¸éœ€è¦é‡æ–°åŠ è½½ã€‚

## åº”ç”¨ç¨‹åºç¤ºä¾‹

è¿™å°±æ˜¯æˆ‘çš„åº”ç”¨ç¨‹åºè¡Œä¸ºã€‚ä¸ºäº†æ›´å¥½åœ°è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªæœ‰8ä¸ªæŒ‰é’®çš„åº”ç”¨ç¨‹åºï¼Œ4ä¸ªæŒ‰é’®æ˜¯æ·»åŠ 1-4çš„ç‰‡æ®µï¼Œ4ä¸ªæŒ‰é’®ç”¨ç‰‡æ®µ1-1æ¥æ›¿æ¢ã€‚ 

![](https://ws2.sinaimg.cn/large/006tKfTcgy1frowk1t2h0j308w0foaaj.jpg)

ä»£ç å¯ä»¥åœ¨ä¸‹é¢è®¿é—®ã€‚[[PR](https://github.com/elye/issue_android_fragment_replace_add_replace)]

## é—®é¢˜è¯´æ˜

ä¸Šé¢çš„åº”ç”¨ç¨‹åºï¼Œå½“ä½ ç‚¹å‡»ä»»ä½•æŒ‰é’®æ—¶ï¼Œä¸€ä¸ªç‰‡æ®µå°†è¢«æ·»åŠ æˆ–æ›¿æ¢åˆ°æ´»åŠ¨å®¹å™¨ã€‚å¯¹äºå…¶ä¸­ä»»ä½•ä¸€ä¸ª(æ·»åŠ æˆ–æ›¿æ¢) ï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨ back-stack ä¸­çš„è·Ÿè¸ªï¼Œè¿™æ ·ç”¨æˆ·å°±å¯ä»¥ä»¥ç›¸åçš„é¡ºåºå°†å®ƒä»¬è¿”å›ã€‚ 

ä¸ºäº†æ›´å¥½åœ°è¯´æ˜è¿™ä¸€ç‚¹ï¼Œæ‚¨å¯ä»¥å•å‡»ã€‚

### æ·»åŠ 4ä¸ªç‰‡æ®µ

æ·»åŠ ç‰‡æ®µ1â†’æ·»åŠ ç‰‡æ®µ2â†’æ·»åŠ ç‰‡æ®µ3â†’æ·»åŠ ç‰‡æ®µ4ï¼Œç„¶ååœ¨å®¹å™¨ä¸­å †å 4ä¸ªç‰‡æ®µã€‚

![](https://ws2.sinaimg.cn/large/006tKfTcgy1frowk4gwqoj30c209qjru.jpg)

å½“æ‚¨æŒ‰ä¸‹å·¥å…·èœå•ä¸Šçš„è¿”å›æŒ‰é’®ï¼ˆå³å·¦ä¸Šè§’çš„â†é”®ï¼‰æ—¶ï¼Œæ¯ä¸ªç‰‡æ®µéƒ½ä¼šå¼¹å‡ºï¼Œç›´åˆ°è¾¾åˆ°åŸå§‹çŠ¶æ€ï¼ˆæ²¡æœ‰ç‰‡æ®µï¼‰ã€‚

è¿™ä¸€åˆ‡éƒ½å¾ˆå¥½ã€‚ 

å¦ä¸€ç§æƒ…å†µæ˜¯ã€‚

### æ›¿æ¢4ä¸ªç‰‡æ®µ

ç”¨ç‰‡æ®µ1æ›¿æ¢â†’ç”¨ç‰‡æ®µ2æ›¿æ¢â†’ç”¨ç‰‡æ®µ3æ›¿æ¢â†’ç”¨ç‰‡æ®µ4æ›¿æ¢ï¼Œé‚£ä¹ˆä½ å°±ä¼šå¾—åˆ°ä¸€ä¸ªç‰‡æ®µï¼Œå³å‰©ä½™çš„ç‰‡æ®µ4ã€‚

![](https://ws3.sinaimg.cn/large/006tKfTcgy1frowk6r43pj30f009ojrw.jpg)

å½“æ‚¨æŒ‰ä¸‹å·¥å…·èœå•ä¸Šçš„åé€€æŒ‰é’®ï¼ˆå³å·¦ä¸Šè§’çš„â†é”®ï¼‰æ—¶ï¼Œå®¹å™¨ä¸­çš„ç‰‡æ®µå°†å¼¹å‡ºï¼Œæ›¿æ¢ä¸ºä¹‹å‰çš„ç‰‡æ®µï¼Œä¸€æ¬¡ä¸€ä¸ªã€‚æ‰€æœ‰è¿™äº›éƒ½æ˜¯å¥½çš„ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥åˆ°è¾¾åŸæ¥çš„çŠ¶æ€ï¼Œé‚£é‡Œçš„å®¹å™¨é‡Œæ²¡æœ‰ç‰‡æ®µã€‚ 

## é—®é¢˜ - æ··åˆæ·»åŠ å’Œæ›¿æ¢åˆ°å †æ ˆä¸­

å½“æ··åˆæ·»åŠ å’Œæ›¿æ¢æ—¶ï¼Œæœ‰å„ç§å¯èƒ½çš„ç»„åˆã€‚ åœ¨å…¶ä¸­çš„ä¸€äº›ç»„åˆä¸­ï¼Œå½“æˆ‘ä»¬å¼€å§‹å¼¹å‡ºç‰‡æ®µæ—¶ï¼Œå®ƒä¼šåœ¨æŸä¸€ç‚¹ä¸Šå¡ä½(ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨å·¦ä¸Šæ–¹æŒ‰ä¸‹â† keyï¼Œä¸ä¼šå¼¹å‡ºç‰‡æ®µğŸ’¥)ã€‚ 

> è§£å†³æ–¹æ³•æ˜¯ï¼Œä½¿ç”¨ç¡¬ä»¶é”®è¿”å›ï¼Œä»ç„¶å¯ä»¥å¼¹å‡ºç‰‡æ®µã€‚åªæ˜¯å·¥å…·æ â†ä¸å†èµ·ä½œç”¨ã€‚å¥‡æ€ªçš„è¡Œä¸ºã€‚

è®©æˆ‘é€‰æ‹©ä¸€äº›ç»„åˆï¼Œå¹¶å‘Šè¯‰ä½ å“ªä¸ªæ˜¯å¥½çš„ï¼Œå“ªä¸ªä¸æ˜¯ï¼ˆæˆ‘å°†ç¼©å†™æ·»åŠ ç‰‡æ®µ x ä½œä¸ºæ·»åŠ  x å¹¶å°†ç‰‡æ®µ x æ›¿æ¢ä¸º Rep xï¼Œç„¶åæŒ‰â†ä»¥ pop å¼¹å‡ºï¼‰ã€‚

åŸºäºè¿™ä¸ªç»“æœï¼Œçœ‹çœ‹ä½ æ˜¯å¦èƒ½å¤Ÿå‘ç°å¯¼è‡´è¿™ä¸ªé—®é¢˜çš„ç»„åˆæ¨¡å¼ï¼Ÿ 

1. `Rep 1` â†’ `Rep 2` â†’ `Add 3` â†’ `Add 4` : `Pop` å››ä¸ªç‰‡æ®µéƒ½æ²¡é—®é¢˜ 
2. `Add 1` â†’ `Rep 2` â†’ `Add 3` â†’ `Add 4` : `Pop` å››ä¸ªç‰‡æ®µéƒ½æ²¡é—®é¢˜ 
3. `Add 1` â†’ `Rep 2` â†’ `Rep 3` â†’ `Rep 4` : `Pop` å››ä¸ªç‰‡æ®µéƒ½æ²¡é—®é¢˜ 
4. `Add 1` â†’ `Rep 2` â†’ `Rep 3` â†’ `Add 4` : `Pop` å››ä¸ªç‰‡æ®µéƒ½æ²¡é—®é¢˜ 
5. `Add 1` â†’ `Add 2` â†’ `Rep 3` â†’ `Add 4` : `Pop` å¡åœ¨ç‰‡æ®µ 1 ğŸ’¥
6. `Rep 1` â†’ `Add 2` â†’ `Rep 3` â†’ `Add 4` : `Pop` å¡åœ¨ç‰‡æ®µ 1 ğŸ’¥
7. `Rep 1` â†’ `Add 2` â†’ `Add 3` â†’ `Rep 4` : `Pop` å¡åœ¨ç‰‡æ®µ 2 ğŸ’¥

ä½ èƒ½ä»ä¸Šé¢å‘ç°é€ æˆé—®é¢˜çš„æ¨¡å¼å—ï¼Ÿ æŠŠå®ƒå½“åšä¸€ä¸ªå°å°çš„è§£è°œé¢˜ã€‚ 

å¦‚æœä½ è®¤ä¸ºä¸Šé¢ç»™å‡ºçš„ç»„åˆæ˜¯ä¸å¤Ÿçš„ï¼Œä¸ºäº†äº§ç”Ÿæ›´å¤šçš„é—®é¢˜çš„æ¨¡å¼ï¼Œä½ å¯ä»¥ç¼–è¯‘ä¸Šé¢ç»™å‡ºçš„ä»£ç ï¼Œç„¶åæµ‹è¯•å‡ºæ¥ã€‚çœ‹çœ‹ä½ èƒ½å¦æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ã€‚ 

> æç¤ºï¼Œå½“ä½ ä½¿ç”¨å·¥å…·æ ä¸Šçš„â†æŒ‰é’®å¼¹å‡ºå¤±è´¥æ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ç¡¬ä»¶åé€€æŒ‰é’®ï¼Œå®ƒåº”è¯¥ä»ç„¶èƒ½å¤Ÿå¼¹å‡ºå®ƒã€‚

ä¸è¦æ‹…å¿ƒï¼Œå¦‚æœä½ ä¸èƒ½æ‰¾å‡ºé—®é¢˜æ‰€åœ¨ï¼Œç­”æ¡ˆåœ¨ä¸‹é¢ã€‚

## æ¼”ç¤ºè¯´æ˜

æ— è®ºå¦‚ä½•ï¼Œå¯¹äºé‚£äº›å–œæ¬¢é˜…è¯»çš„äººæ¥è¯´ï¼Œæ›´æ¸…æ¥šåœ°è¯´æ˜è¿™ä¸ªé—®é¢˜ã€‚ ä¸‹é¢çš„è§†é¢‘å±•ç¤ºäº†3ä¸ªåœºæ™¯ 

1. `Add 1` â†’ `Add 2` â†’ `Add 3` â†’ `Add 4` : æ‰€æœ‰ `pop` å¾ˆå¥½ã€‚ ï¼ˆæ³¨æ„æ•°å­—é‡å ï¼Œå› ä¸ºèƒŒæ™¯æ˜¯é€æ˜çš„ï¼Œæ˜¾ç¤ºæ¯ä¸ªç‰‡æ®µç›¸äº’ä¹‹é—´å¢åŠ ï¼‰
2. `Rep 1` â†’ `Rep 2` â†’ `Rep 3` â†’ `Rep 4` : æ‰€æœ‰ `pop` å¾ˆå¥½ã€‚ï¼ˆè¯¥æ•°å­—ä¸å†é‡å ï¼Œå› ä¸ºç‰‡æ®µè¢«æ›¿æ¢ï¼‰
3. `Add 1` â†’ `Rep 2` â†’`Add 3` â†’ `Rep 4` :   `pop` å¡åœ¨ç‰‡æ®µ 2ğŸ’¥ã€‚ä¸ºä»€ä¹ˆï¼Ÿï¼ï¼ï¼Ÿ

![](https://cdn-images-1.medium.com/max/800/1*SuNvR_z3AwZLu4BWcfBoUw.gif)

## ä»¤äººä¸å®‰çš„æ¨¡å¼ - è§£ç­”è¿™ä¸ªéš¾é¢˜

ç»è¿‡ä¸€ç•ªè°ƒæŸ¥åï¼Œå‘ç°é€ æˆè¿™ä¸ªé—®é¢˜çš„éº»çƒ¦æ¨¡å¼ã€‚

è¿™ä¸ªæ¨¡å¼æ˜¯é’ˆå¯¹æ¯ä¸€ä¸ªå·²ç»æ˜¾ç¤ºåœ¨é‚£ä¹‹å‰çš„ç‰‡æ®µçš„æ·»åŠ å’Œæ›¿æ¢ï¼Œå¼¹å‡ºå°†åœç•™åœ¨è¯¥ç‰‡æ®µã€‚ ä¾‹å¦‚: 

`Add or Rep 1` â†’ `Add 2` â†’ `Rep 3`. ç„¶åï¼Œ`pop` å¡åœ¨ 1ã€‚

æ‚¨å¯ä»¥æ¢å¤ç»™å‡ºçš„ä¸Šè¿°8ç§ç»„åˆï¼Œå¹¶ä¸”ç¡®è®¤è¿™ç§æ¨¡å¼æ˜¯åœ¨å¼•èµ·é—®é¢˜çš„4ç§ç»„åˆä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œè€Œä¸æ˜¯åœ¨å…¶ä»–4ä¸ªç»„åˆä¸­ã€‚ 

## æ·±å…¥ç ”ç©¶è¿™ä¸ªé—®é¢˜

é‰´äºè¿™ç§ä»¤äººä¸å®‰çš„æ¨¡å¼ï¼Œç°åœ¨å¯ä»¥æ›´å®¹æ˜“åœ°ä½¿ç”¨é‡ç°é—®é¢˜çš„æœ€å°æ­¥éª¤æ¥é‡å¤è¿™ä¸ªé—®é¢˜ã€‚ è®©æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„æµç¨‹ã€‚ 

`Rep 1` â†’ `Add 2` â†’ `Rep 3`

ä¸ºäº†æ·±å…¥ç ”ç©¶ï¼Œæˆ‘ä»¬æ¥è¿½è¸ªç‰‡æ®µå †æ ˆæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚ 

æ­¥éª¤1ï¼šRep 1 ï¼šç”¨ç‰‡æ®µ1æ›¿æ¢ç©ºå®¹å™¨ã€‚ä¸‹å›¾æ˜¾ç¤ºäº†è¯¥å›¾ã€‚

![](https://ws3.sinaimg.cn/large/006tKfTcgy1frownt2ojyj30ci0923ym.jpg)

æ­¥éª¤2ï¼šAdd 2ï¼šåœ¨ç‰‡æ®µ1çš„é¡¶éƒ¨æ·»åŠ ç‰‡æ®µ2ã€‚

![](https://ws4.sinaimg.cn/large/006tKfTcgy1frowovg9ssj30bi09cmxe.jpg)

æ­¥éª¤3ï¼šRep 3ï¼šç”¨ç‰‡æ®µ3æ›¿æ¢å®¹å™¨ã€‚ç„¶åï¼Œå°†ç‰‡æ®µ1å’Œ2ä»å®¹å™¨ä¸­æ¨å‡ºã€‚

![](https://ws3.sinaimg.cn/large/006tKfTcgy1frowoxv7guj30f009idg8.jpg)

æ­¥éª¤4ï¼šPop 3ï¼šæŒ‰ä¸‹å·¦ä¸Šè§’çš„â†é”®ï¼Œå¼¹å‡º Fragment 3ã€‚å½“ç‰‡æ®µ3å¼¹å‡ºæ—¶ï¼Œç‰‡æ®µ1å’Œç‰‡æ®µ2è¢«ç³»ç»Ÿå¸¦å›åˆ°å®¹å™¨ä¸­ã€‚

![](https://ws1.sinaimg.cn/large/006tKfTcgy1frowp01l0cj30bi09cmxe.jpg)

æ­¥éª¤5ï¼šPop 2ï¼šå†æ¬¡æŒ‰å·¦ä¸Šæ–¹çš„â†é”®ï¼Œå¼¹å‡º Fragment 2ã€‚ç‰‡æ®µ1ä»ç„¶ä¿ç•™åœ¨å®¹å™¨ä¸­ã€‚

![](https://ws4.sinaimg.cn/large/006tKfTcgy1frowp2c6haj30ci0923ym.jpg)

æ­¥éª¤6ï¼šPop 1ğŸ’¥ï¼šå†æ¬¡æŒ‰å·¦ä¸Šæ–¹çš„â†é”®ï¼Œå¸Œæœ›å¼¹å‡ºç‰‡æ®µ1ï¼Œä½†æ²¡æœ‰ä»»ä½•ååº”ï¼Ÿ ğŸ’¥ã€‚å·¦ä¸Šæ–¹çš„â†é”®ä¸å†æœ‰æ•ˆï¼ä¸ºä»€ä¹ˆï¼Ÿ

## é—®é¢˜çš„ç½ªé­ç¥¸é¦–

æ˜¾ç„¶ï¼Œè¿™ä¸ªé—®é¢˜çš„ç½ªé­ç¥¸é¦–ä¸åœ¨ç¬¬å…­æ­¥ã€‚ è§¦å‘ç‚¹å‘ç”Ÿåœ¨ä¸Šé¢çš„æ­¥éª¤4ã€‚ è¿™æ—¶ï¼Œç‰‡æ®µ1å’Œç‰‡æ®µ2è¢«æ¢å¤åˆ°å®¹å™¨ä¸­ã€‚ 

å½“æ—¶ï¼Œè¿™ä¸¤ä¸ªç¢ç‰‡è¢«é‡æ–°åˆ›å»ºå‡ºæ¥ã€‚ å½“ä¸¤ä¸ªç‰‡æ®µè¢«é‡æ–°åˆ›å»ºæ—¶ï¼Œä¸¤ä¸ªç‰‡æ®µéƒ½è°ƒç”¨åˆ° 

```kotlin
(activity as AppCompatActivity).setSupportActionBar(toolbar)
```

ç†æƒ³æƒ…å†µä¸‹ï¼Œè¿™åº”è¯¥æ˜¯å¯è¡Œçš„ï¼Œå› ä¸ºè°ƒç”¨çš„åºåˆ—ä»ç„¶æ˜¯æ­£ç¡®çš„ï¼Œç‰‡æ®µ1é¦–å…ˆè¢«æ¢å¤ï¼Œæ¥ç€æ˜¯ç‰‡æ®µ2ã€‚ ç„¶è€Œï¼Œç”±äºæŸç§åŸå› ï¼Œç”±äºä¸¤è€…çš„è°ƒç”¨æ—¶é—´å‡ ä¹ç›¸å½“æ¥è¿‘ï¼Œç‰‡æ®µ1çš„å·¥å…·æ ä¸å†å·¥ä½œäº†ã€‚ 

> æˆ‘é«˜åº¦æ€€ç–‘è¿™æ˜¯ setSupportActionBarä¸Š SDK åº“çš„é—®é¢˜ã€‚æˆ‘é€šè¿‡ [issues](https://issuetracker.google.com/issues/73793626) å‘ Google æäº¤äº†ä¸€ä¸ªé—®é¢˜ã€‚

## é—®é¢˜çš„è§£å†³æ–¹æ³•

é‰´äºè¿™åœ¨æˆ‘çœ‹æ¥åƒæ˜¯ä¸€ä¸ªè°·æ­Œé”™è¯¯ï¼Œæˆ‘ä¸è®¤ä¸ºæˆ‘æœ‰ä¸€ä¸ªå¾ˆå¥½çš„è§£å†³æ–¹æ¡ˆã€‚ æˆ‘ä¹Ÿä¸èƒ½ç­‰å¾…è°·æ­Œï¼Œå› ä¸ºåˆ°ç›®å‰ä¸ºæ­¢åŸºäºç»éªŒï¼Œå®ƒéœ€è¦ä¸€ä¸ªæœˆçš„æ—¶é—´æ¥è§£å†³æ‰€æŠ¥é“çš„é—®é¢˜ï¼Œé™¤éè¿™ä¸ªé—®é¢˜éå¸¸æ˜æ˜¾ï¼Œå½±å“åˆ°æ¯ä¸€ä¸ªäººã€‚ 

æ‰€ä»¥æˆ‘å¿…é¡»è§£å†³ã€‚

ä»åº”ç”¨ç¨‹åºçš„è§’åº¦æ¥çœ‹ï¼Œä½¿ç”¨ç¡¬ä»¶è¿”å›æŒ‰é’®ä»ç„¶èƒ½å¤Ÿè§¦å‘ onBackPressed ( ) åœ¨æ´»åŠ¨ä¸­çš„åŠŸèƒ½ï¼Œå› æ­¤å¼¹å‡ºç‰‡æ®µä»ç„¶æ˜¯å¯èƒ½çš„ã€‚ ä½†æ˜¯ç”¨æˆ·çœŸçš„å¸Œæœ›æŒ‰ä¸‹å·¦ä¸Šè§’çš„â† key æ¥å¼¹å‡ºå †æ ˆã€‚ 

## ä½¿å·¥å…·æ ç”Ÿæ•ˆçš„ä»£ç 

æˆ‘è¿˜å‘ç°ï¼Œå¦‚æœç‰‡æ®µ2å‘ç”Ÿäº†å˜åŒ–ï¼Œå¦‚æœæˆ‘èƒ½è®©ç‰‡æ®µ1å†æ¬¡è°ƒç”¨ä¸‹é¢ï¼Œå·¥å…·æ å°±ä¼šæ¢å¤ç”Ÿæ•ˆã€‚ 

```kotlin
(activity as AppCompatActivity).setSupportActionBar(toolbar)
```

ä½†æ˜¯ï¼Œå½“ç‰‡æ®µ2è¢«å¼¹å‡ºæ—¶ï¼Œç‰‡æ®µ1ä¸­çš„ä»£ç å°†ä¸ä¼šè§¦å‘ï¼Œå› ä¸ºç‰‡æ®µ1åœ¨å®¹å™¨ä¸­å·²ç»å­˜åœ¨ã€‚

## å¯è¡Œçš„è§£å†³æ–¹æ³•

æœ‰äº†ä¸Šè¿°çš„æƒ³æ³•ï¼Œæˆ‘ä½¿ç”¨çš„æ–¹æ³•æ˜¯ï¼Œæ¯å½“ä¸€ä¸ªå¼¹å‡ºå‘ç”Ÿæ—¶ï¼Œè®©é¡¶å±‚çš„ç‰‡æ®µè°ƒç”¨è¿™ä¸ª 

```kotlin
(activity as AppCompatActivity).setSupportActionBar(toolbar)
```

è¿™å°†ç¡®ä¿é¡¶çº§ç‰‡æ®µå§‹ç»ˆå…·æœ‰å®ƒçš„å·¥å…·æ é‡ç½®å’Œç”Ÿå­˜ã€‚ 

ä¸ºäº†æ£€æµ‹ç‰‡æ®µå¼¹å‡ºï¼Œæˆ‘åœ¨æ´»åŠ¨ä¸­ä½¿ç”¨ä¸‹é¢çš„æ–¹æ³•ï¼Œè°ƒç”¨é¡¶éƒ¨ç‰‡æ®µçš„ onResumeã€‚ 

```kotlin
supportFragmentManager.addOnBackStackChangedListener {
    val currentFragment = supportFragmentManager
                            .findFragmentById(R.id.container)
    currentFragment?.onResume()
}
```

> æ³¨æ„ onBackStackChangedListener è·å–ç‰‡æ®µçš„ push å’Œ pop ä¸¤ä¸ªè§¦å‘å™¨ã€‚æˆ‘æ²¡æœ‰åœ¨é‚£é‡ŒåŒºåˆ†ä»–ä»¬ã€‚

å¯¹äºæ‰€æœ‰çš„ç‰‡æ®µï¼Œæˆ‘æ˜ç¡®åœ°åšå‡ºå¦‚ä¸‹çš„ onResumeã€‚

```kotlin
override fun onResume() {
    super.onResume()
    (activity as AppCompatActivity)
                            .setSupportActionBar(toolbar_actionbar)
}
```

ä½¿ç”¨è¿™äº›ä»£ç æ—¶ï¼Œæ— è®ºä½¿ç”¨æ·»åŠ è¿˜æ˜¯æ›¿æ¢ï¼Œéƒ½å¯ä»¥ä½¿ç”¨å·¥å…·æ ä¸Šçš„â†æŒ‰é’®éšæ—¶å¼¹å‡ºç‰‡æ®µä¸­çš„æ‰€æœ‰æŒ‰é’®å’Œå¼¹å‡ºçª—å£ï¼Œè€Œä¸ç®¡ä½¿ç”¨æ·»åŠ è¿˜æ˜¯æ›¿æ¢ã€‚[[PR](https://github.com/elye/issue_android_fragment_replace_add_replace_workaround)]

æˆ‘è®¤ä¸ºæˆ‘çš„è§£å†³æ–¹æ³•ä¹Ÿä¸ç†æƒ³ã€‚ä½†è‡³å°‘å®ƒèƒ½è®©äº‹æƒ…å¥æ•ˆã€‚å¦‚æœä½ çŸ¥é“è¿™ä¸ªé—®é¢˜æœ‰æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼Œè¯·éšæ—¶åˆ†äº«ã€‚ä½ ä¹Ÿå¯ä»¥å°†å®ƒè´´åœ¨ä¸‹é¢çš„ stackoverflow ä¸Šã€‚

[Replace, add, replace fragment, then the Navigation Back button not working for first fragment Join Stack Overflow to learn, share knowledge, and build your career. I have a fragment stack, where I use replace andâ€¦ stackoverflow.com](https://stackoverflow.com/questions/48941001/replace-add-replace-fragment-then-the-navigation-back-button-not-working-for)

å¦‚æœæ²¡æœ‰ï¼ŒçœŸè¯šåœ°å¸Œæœ› Google èƒ½å¤Ÿé€šè¿‡ [issues](https://issuetracker.google.com/issues/73793626) æŠ¥å‘Šè§£å†³æ­¤é—®é¢˜çš„ä¸€äº›è§£å†³æ–¹æ¡ˆã€‚

å¸Œæœ›è¿™ç¯‡æ–‡ç« æ˜¯æœ‰å¸®åŠ©çš„ï¼Œä½ å¾ˆæ¬£èµå®ƒã€‚è¯·ä¸ä»–äººåˆ†äº«ã€‚



