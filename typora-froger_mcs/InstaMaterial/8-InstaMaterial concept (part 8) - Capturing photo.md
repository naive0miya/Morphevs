# InstaMaterial æ¦‚å¿µ(ç¬¬8éƒ¨åˆ†) - æ•æ‰ç…§ç‰‡

>åŸæ–‡ (mirekstanek.online) ï¼š [InstaMaterial concept (part 8) - Capturing photo](https://mirekstanek.online/instamaterial-concept-part-8-capturing-photo/)
>ä½œè€… ï¼š [Mirek Stanek](https://twitter.com/froger_mcs)  

[TOC]

è¿™ç¯‡æ–‡ç« æ˜¯ä¸€ç³»åˆ—å¸–å­çš„ä¸€éƒ¨åˆ†ï¼Œå±•ç¤ºäº†ä½¿ç”¨ [Material Design æ¦‚å¿µçš„ INSTAGRAM](https://www.youtube.com/watch?v=ojwdmgmdR_Q) çš„ Android å®ç°ã€‚ ä»Šå¤©ï¼Œæˆ‘ä»¬å°†åˆ›å»ºç…§ç‰‡æ•æ‰æµç¨‹ã€‚ è¿™ä¸ªåŠŸèƒ½ä»‹äºæ¦‚å¿µè§†é¢‘çš„ç¬¬38å’Œç¬¬41ç§’ä¹‹é—´ã€‚ æˆ‘ä»¬ä¼šçœç•¥ä¸€äº›ç»†èŠ‚ï¼ˆæ¯”å¦‚ FAB æŒ‰é’®çš„åŠ¨ç”»ï¼Œé¢œè‰²ï¼Œå›¾æ ‡ï¼‰ï¼Œå› ä¸ºåœ¨å®ç°ç›¸æœºæ–¹é¢è¿˜æœ‰ä¸€äº›å·¥ä½œè¦åšã€‚ æˆ‘ä»¬ä¼šåœ¨ä¸‹ä¸€ä¸ªï¼ˆå¯èƒ½æ˜¯æœ€åä¸€ä¸ªï¼‰ç³»åˆ—çš„å¸–å­ä¸­å›åˆ°ä»–ä»¬ã€‚

æ ¹æ®[ä¹‹å‰çš„å¸–å­](http://frogermcs.github.io/InstaMaterial-concept-part-7-navigation-drawer/)ï¼Œæˆ‘ä¸å¾—ä¸æåˆ° InstaMaterial åº”ç”¨ç¨‹åºå·²ç»ç”±äºè¿åçŸ¥è¯†äº§æƒè€Œä» Google Play å•†åº—ä¸­åˆ é™¤ã€‚ æˆ‘å……åˆ†ç†è§£äº†è¿™ä¸ªåŸå› ï¼Œä¸ä¹…çš„å°†æ¥ï¼Œæˆ‘å¯èƒ½ä¼šå‡†å¤‡ä¸ Instagram åº”ç”¨ç¨‹åºå®Œå…¨ä¸åŒçš„å¸ƒå±€ç‰ˆæœ¬ï¼ˆä½†ä»ç„¶å…·æœ‰æ¦‚å¿µè§†é¢‘ä¸­æä¾›çš„æ‰€æœ‰åŠŸèƒ½ï¼‰ã€‚

ä»ä»Šå¤©å‘å¸ƒçš„ä»£ç æ„å»ºçš„ APK æ–‡ä»¶å¯ä»¥åœ¨[è¿™é‡Œ](https://github.com/frogermcs/frogermcs.github.io/raw/master/files/9/instamaterial-debug.apk)æ‰¾åˆ°ã€‚

ç°åœ¨è®©æˆ‘ä»¬å›åˆ°è¿™ä¸ªå¸–å­ - è¿™æ˜¯æˆ‘ä»¬ä»Šå¤©æƒ³è¦è¾¾åˆ°çš„æœ€ç»ˆæ•ˆæœï¼š

<iframe width="560" height="315" src="https://youtu.be/0w3lGJIISTo" frameborder="0" allowfullscreen></iframe>

## æ¦‚è®º
ä»Šå¤©æè¿°çš„å‡ ä¹æ‰€æœ‰çš„è§£å†³æ–¹æ¡ˆå’ŒåŠ¨ç”»éƒ½å‡ºç°åœ¨ä¹‹å‰çš„å¸–å­ä¸­ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸ä¼šä¸“æ³¨äºè¯¦ç»†çš„æè¿°ã€‚ ä½†æ˜¯ä¹Ÿä¼šæœ‰ä¸€ä¸ªå…¨æ–°çš„å…ƒç´ æ‘„åƒæœºã€‚ é‚£äº›ä»¥å‰æ›¾ç»ä¸å®ƒåˆä½œè¿‡çš„äººçŸ¥é“ï¼Œè¿™ä¸ªå†…å®¹å¯¹äºå®ç°æ¥è¯´æœ‰ç‚¹é—®é¢˜ã€‚ ä¸ºä»€ä¹ˆï¼Ÿ ç®€è€Œè¨€ä¹‹ï¼Œå®‰å“ä½œä¸ºä¸€ä¸ªå¼€æ”¾çš„å¹³å°å¯ä»¥å¤„ç†éå¸¸å¹¿æ³›çš„è®¾å¤‡ä¸å®Œå…¨ä¸åŒçš„ç¡¬ä»¶(ç‰¹åˆ«æ˜¯ç›¸æœº)è§„èŒƒã€‚ å› æ­¤ï¼Œå¦‚æœä½ åœ¨è¿™é‡Œå¼€å§‹ä½ çš„æ‹æ‘„å·¥ä½œï¼Œä½ éœ€è¦æ³¨æ„çš„æ˜¯ä¸€äº›ç®€çŸ­çš„åˆ—è¡¨:

- ä¸åŒçš„é¢„è§ˆå’Œæ•è·çš„å›¾åƒ

  æ¯ä¸ªè®¾å¤‡éƒ½æœ‰ä¸€ä¸ªæœ‰é™çš„æ”¯æŒå°ºå¯¸(å¯¹äºé¢„è§ˆå’Œæ•è·çš„å›¾åƒ)ã€‚ ä½ åº”è¯¥è®°ä½ï¼Œä¾‹å¦‚ï¼Œä¸€äº›è®¾å¤‡ä¸èƒ½å¤„ç†1:1æ¯”ä¾‹(å¹³æ–¹å›¾åƒ)çš„å°ºå¯¸-å®é™…ä¸Š Nexus 5å°±æ˜¯å…¶ä¸­ä¹‹ä¸€ã€‚ æ‰€ä»¥è¦åšå¥½å¤„ç†ä½å›¾æ“ä½œçš„å‡†å¤‡ã€‚

- å/å‰ç½®æ‘„åƒå¤´
  æ¯ä¸ªè®¾å¤‡éƒ½å¯ä»¥æœ‰å‰åç›¸æœºã€‚ å½“ç„¶ï¼Œä¹Ÿæœ‰åªæœ‰ä¸€ä¸ªèƒŒé¢çš„è®¾å¤‡ï¼Œä½†è¯·è®°ä½ï¼Œå…¶ä¸­ä¸€äº›åªæœ‰å‰ç½®æ‘„åƒå¤´ï¼ˆå³Nexus 7 2012ï¼‰ã€‚ å½“ç„¶ï¼Œä»–ä»¬æ¯ä¸ªäººéƒ½å¯ä»¥æœ‰ä¸åŒçš„æ”¯æŒçš„å¤§å°åˆ—è¡¨ã€‚

- ä¸åŒçš„æ”¯æŒåŠŸèƒ½ 

  æœ‰äº›è®¾å¤‡ä¸æ”¯æŒè‡ªåŠ¨å¯¹ç„¦ï¼Œå¦ä¸€ä¸ªä¸æ”¯æŒç¼©æ”¾ã€‚ åœ¨æˆ‘ä»¬å¼€å§‹ä½¿ç”¨ä»»ä½•åŠŸèƒ½ä¹‹å‰ï¼Œä½ åº”è¯¥æ£€æŸ¥å®ƒæ˜¯å¦å­˜åœ¨ã€‚

- å¤„ç†ç›¸æœºæ“ä½œæ˜¯éå¸¸è´¹åŠ›çš„ã€‚

  ä½ åº”è¯¥è®°ä½ï¼Œå›¾åƒ(ç‰¹åˆ«æ˜¯é‚£äº›åœ¨å¤§å‹åˆ†è¾¨ç‡åˆ†è¾¨ç‡ä¸‹æ‹æ‘„çš„å›¾ç‰‡)æ˜¯éå¸¸éœ€è¦é€šè¿‡è®¾å¤‡æ¥ç»´æŠ¤çš„ã€‚ å›¾åƒå¤„ç†ä¸æ˜¯æœ€è½»çš„äº‹æƒ…ï¼Œæ‰€ä»¥ä½ åº”è¯¥å…³æ³¨å†…å­˜ç®¡ç†å’Œä¸» UI çº¿ç¨‹ä¹‹å¤–çš„è®¡ç®—ã€‚ å¦ä¸€ä¸ªè´Ÿé¢å› ç´ æ˜¯ï¼Œåœ¨è°ƒç”¨ä¹‹åï¼Œç›¸æœºè¿˜æ²¡æœ‰å‡†å¤‡å¥½â€”â€”æœ‰æ—¶å€™ä½ åº”è¯¥ç­‰å¾…åˆå§‹åŒ–ã€‚

æ ¹æ®ä¸Šé¢æè¿°çš„ä¸€äº›è§‚ç‚¹ï¼Œæˆ‘å†³å®šä½¿ç”¨å¤–éƒ¨åº“æ¥å¤„ç†ç›¸æœºæ“ä½œï¼Œè€Œä¸æ˜¯ç¼–å†™è‡ªå·±çš„å®ç°ã€‚ æˆ‘é€‰æ‹©äº† [CWAC-Camera](https://github.com/commonsguy/cwac-camera) åº“ï¼Œå®ƒå¯¹äºå®ç°æ¥è¯´ä¹Ÿæœ‰ç‚¹å¤æ‚ï¼Œä½†å®ƒéœ€è¦å¤„ç†å¤§é‡çš„è¾¹ç¼˜æƒ…å†µã€‚ [å³ä½¿ä½œè€…æ‰“ç®—å®Œå…¨é‡å†™å®ƒ](http://commonsware.com/blog/2014/12/01/my-mistakes-cwac-camera.html)ï¼Œåœ¨æˆ‘çœ‹æ¥ä¹Ÿæ²¡æœ‰æ›´å¥½çš„èµ·ç‚¹æ¥å¤„ç†ç…§ç‰‡ / è§†é¢‘æ•æ‰ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹ä¹‹å‰æœ€åä¸€ä»¶äº‹ã€‚ åœ¨ InstaMaterial åº”ç”¨ç¨‹åºä¸­çš„ç›¸æœºå®ç°æ˜¯éå¸¸æœ‰é™çš„ã€‚ å›¾ç‰‡æ–‡ä»¶å¤„ç†å’Œæ•è·å›¾åƒæ˜¾ç¤ºæ²¡æœ‰é€»è¾‘å¯è¨€ï¼Œè¿™æ˜¯éå¸¸æ£˜æ‰‹çš„ã€‚ åœ¨è¿™ä¸ªä»£ç å‡†å¤‡æŠ•å…¥ç”Ÿäº§ä¹‹å‰ï¼Œè¿˜æœ‰å¾ˆå¤šå·¥ä½œè¦åš(ç‰¹åˆ«æ˜¯ä½¿ç”¨ä½å›¾è£å‰ªï¼Œé€‰æ‹©åˆé€‚çš„å›¾åƒå¤§å°ç­‰ç­‰)ã€‚ ä½†æˆ‘ç›¸ä¿¡ï¼Œå¯¹äºæ›´å¤æ‚çš„é¡¹ç›®æ¥è¯´ï¼Œè¿™å¯èƒ½æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„åˆä½œä¼™ä¼´ã€‚

## å‡†å¤‡
è®©æˆ‘ä»¬ä¸€å¦‚æ—¢å¾€åœ°å¢åŠ ä¸€äº›èµ„æºå’Œä¸é‚£ä¹ˆé‡è¦çš„æ¨¡æ¿ã€‚ è¿˜æœ‰ä¸€äº›åº“å·²ç»æ›´æ–°ã€‚ ä»ç°åœ¨å¼€å§‹ï¼Œé¡¹ç›®ä¹Ÿæœ‰äº†æ–°çš„ç»“æ„:
![|center](http://frogermcs.github.io/images/9/project_structure.png)
ä¸è¦æŠŠå®ƒå½“ä½œæœ€ç»ˆçš„å‚è€ƒï¼Œä½†æ˜¯åœ¨çœŸå®çš„é¡¹ç›®ä¸­ï¼Œè¿™æ˜¯æˆ‘æœ€å–œæ¬¢çš„ç»“æ„ï¼Œå…¶ä¸­ ui / logic / data å°†æ ‘åˆ†å¼€ï¼ˆå¦ä¸€ä¸ªé€‰é¡¹æ˜¯é€šè¿‡åŠŸèƒ½æ¥æŒ‡å®šæ ‘ï¼Œä½†æ˜¯åœ¨è¾ƒå°çš„é¡¹ç›®ä¸­å¯ä»¥æ˜¯å¤šä½™çš„ï¼‰ã€‚

ä¸‹é¢æ˜¯ commit åˆ—è¡¨:

- [libraries update](https://github.com/frogermcs/InstaMaterial/commit/cabb984c918e11fddb333bf4e5a2593020f7d633)
- [project structure update](https://github.com/frogermcs/InstaMaterial/commit/9c62d60682990ba549c3fe72b82c956088a61188)
- [new required resources](https://github.com/frogermcs/InstaMaterial/commit/36381c47e47d4da1ae3ce32702fba598fd96346f)

## CWAC-Camera é…ç½®
ç›¸æœºåº“çš„å®‰è£…éå¸¸ç®€å•ã€‚æˆ‘ä»¬æ‰€è¦åšçš„å°±æ˜¯åœ¨ `<project> `/build.gradle æ–‡ä»¶ä¸­æ·»åŠ æ–°çš„ Maven ä»“åº“ï¼š
```groovy
repositories {
    maven {
        url "https://repo.commonsware.com.s3.amazonaws.com"
    }
}
```
ä»¥åŠ `<project>` /app/build.gradle ä¸­çš„æ–°ä¾èµ–é¡¹ï¼š
```groovy
dependencies {
	//...
    compile 'com.commonsware.cwac:camera:0.6.12'
}
```
æœ€åï¼Œæˆ‘ä»¬å¿…é¡»åœ¨ AndroidManifest.xml æ–‡ä»¶ä¸­æ·»åŠ æ–°çš„æƒé™ï¼š
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="io.github.froger.instamaterial">

    <!--...-->
    <uses-permission android:name="android.permission.CAMERA" />
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />

    <uses-feature
        android:name="android.hardware.camera"
        android:required="true" />
    <uses-feature
        android:name="android.hardware.camera.front"
        android:required="false" />
    <uses-feature
        android:name="android.hardware.camera.autofocus"
        android:required="false" />

    <application
        android:name=".InstaMaterialApplication"
        android:icon="@drawable/ic_launcher"
        android:label="@string/app_name"
        android:theme="@style/AppTheme">
        
        <!--...-->
        
    </application>

</manifest>
```

## ç…§ç‰‡æ•æ‰å±å¹•
ç°åœ¨æˆ‘ä»¬å¯ä»¥å¼€å§‹å®ç°æ•æ‰å±å¹•ã€‚ æˆ‘è€ƒè™‘äº†ä¸¤ç§å®ç°æ–¹å¼â€”â€”ä¸¤ç§ä¸åŒçš„æ‹ç…§å’Œç¼–è¾‘æ´»åŠ¨ï¼Œæˆ–è€…ä¸€ä¸ªä¸è¿™äº›çŠ¶æ€çš„æ´»åŠ¨ã€‚ åœ¨æˆ‘çœ‹æ¥ï¼Œç¬¬ä¸€ä¸ªé€‰é¡¹æ›´æ­£ç¡®(å¯èƒ½æˆ‘ä¼šåœ¨ç”Ÿäº§ä»£ç ä¸­ä½¿ç”¨å®ƒ) ï¼Œä½†æœ€åæˆ‘é€‰æ‹©äº†ç¬¬äºŒç§ã€‚ ä¸ºä»€ä¹ˆï¼Ÿ å› ä¸ºæ²¡æœ‰ç®€å•çš„æ–¹æ³•(ä½†è¿™å¹¶ä¸æ˜¯ä¸å¯èƒ½çš„!) ä»æ‘„åƒæœºé¢„è§ˆåˆ°ç…§ç‰‡é¢„è§ˆçš„è¿‡æ¸¡ï¼Œä¸éœ€è¦å¤ªå¤šçš„å¸ƒå±€ã€‚ é»˜è®¤æƒ…å†µä¸‹ï¼Œç›¸æœºä¿å­˜å¤–éƒ¨å­˜å‚¨çš„ç…§ç‰‡ï¼Œå¦ä¸€ä¸ªæ´»åŠ¨åº”è¯¥ä»é‚£ä¸ªåœ°æ–¹è¯»å‡ºæ¥ã€‚ ä¸å¹¸çš„æ˜¯ï¼Œå®ƒä¼šäº§ç”Ÿä¸€ä¸ªå°å»¶è¿Ÿï¼Œå› æ­¤æˆ‘ä»¬å¿…é¡»æ‰¾å‡ºä¸€äº›è§£å†³æ–¹æ¡ˆï¼Œä»¥ä¾¿åœ¨ä¸¤ä¸ªæ´»åŠ¨ä¹‹é—´ä¼ é€’ä½å›¾(æ¯”é€šè¿‡ Intent çš„ bundle å‘é€ä½å›¾æˆ–å°†ä½å›¾ä¿å­˜ä¸ºé™æ€å­—æ®µæ›´å¤æ‚)ã€‚

æˆ‘ä»¬ä»ä»‹ç»åŠ¨ç”»å¼€å§‹ã€‚ å¯¹äºæ´»åŠ¨è¿‡æ¸¡ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ RevealBackgroundView åœ¨[ä¹‹å‰çš„æ–‡ç« ](http://frogermcs.github.io/InstaMaterial-concept-part-6-user-profile/#custom-revealbackgroundview)ä¸­ä»‹ç»è¿‡ã€‚ æˆ‘ä»¬å¿…é¡»å†æ¬¡é€šè¿‡èµ·å§‹ä½ç½®(è¿™æ¬¡ä» FAB æŒ‰é’®ä¸­è·å–)ã€‚ å”¯ä¸€çš„åŒºåˆ«æ˜¯æˆ‘ä»¬å¿…é¡»æ·»åŠ æ–°çš„æ ·å¼ï¼Œåœ¨ TakePhotoActivity ä¸­éšè—çŠ¶æ€æ ï¼š

```xml
<?xml version="1.0" encoding="utf-8"?>
<!-- styles.xml-->
<resources>

    <!--...-->

    <style name="AppTheme.TransparentActivity.FullScreen">
        <item name="android:windowFullscreen">true</item>
    </style>

    <!--...-->

</resources>
```
å¹¶å°†å…¶è®¾ç½®åœ¨ AndroidManifest æ–‡ä»¶ä¸­ï¼š
```xml
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="io.github.froger.instamaterial">

    <!--...-->
    
        <activity
            android:name=".ui.activity.TakePhotoActivity"
            android:screenOrientation="portrait"
            android:theme="@style/AppTheme.TransparentActivity.FullScreen" />
    
    <!--...-->

</manifest>
```
æäº¤æ‰€æœ‰æè¿°çš„æ›´æ”¹å¯åœ¨[æ­¤å¤„](https://github.com/frogermcs/InstaMaterial/commit/e19395ef14a0a29a558a43d36de050958351f99c)è·å¾—ã€‚

## TakePhotoActivity å¸ƒå±€
ç°åœ¨è®©æˆ‘ä»¬å‡†å¤‡æ•æ‰å±å¹•çš„å¸ƒå±€ã€‚ æ­£å¦‚æˆ‘æ‰€è¯´ï¼Œå®ƒåº”è¯¥å¤„ç†ä¸¤ä¸ªå›½å®¶ - æ•è·å’Œé…ç½®ç…§ç‰‡ã€‚ è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åº”è¯¥å®æ–½å…ƒç´ è½¬æ¢ã€‚ ä¸ºæ­¤æˆ‘ä»¬å°†ä½¿ç”¨ ViewSwitcherï¼Œå®ƒå¯ä»¥å¤„ç†ä»–çš„å­©å­ä¹‹é—´çš„åŠ¨ç”»ï¼ˆåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ TextSwitcher æ¥å®ç°ç±»ä¼¼äºæ‰©å±• ViewSwitcher ç±»çš„åŠ¨ç”»ï¼‰ã€‚

åœ¨æˆ‘ä»¬å¼€å§‹å¸ƒå±€å®ç°ä¹‹å‰ï¼Œæˆ‘ä»¬åº”è¯¥ä¸ºæ•è·æŒ‰é’®å‡†å¤‡èƒŒæ™¯ï¼š
![|center](http://frogermcs.github.io/images/9/btn_capture.png)
å’Œæ•è·é€‰é¡¹ï¼š
![|center](http://frogermcs.github.io/images/9/btn_capture_options.png)
é¦–å…ˆå¯ä»¥åœ¨ .xml æ–‡ä»¶ä¸­åˆ›å»ºã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªåœ†åœˆå±‚å åˆ—è¡¨å’Œé¡¶éƒ¨åœ†å½¢ç¬”åˆ’ï¼š
```xml
<?xml version="1.0" encoding="utf-8"?>
<!--btn_capture.xml-->
<layer-list xmlns:android="http://schemas.android.com/apk/res/android">
    <item>
        <shape android:shape="oval">
            <solid android:color="#458dca" />
        </shape>
    </item>
    <item
        android:bottom="16dp"
        android:left="16dp"
        android:right="16dp"
        android:top="16dp">
        <shape android:shape="oval">
            <solid android:color="#529bd8" />
        </shape>
    </item>
    <item>
        <shape android:shape="oval">
            <stroke
                android:width="2dp"
                android:color="#ffffff"
                android:dashWidth="0dp" />
        </shape>
    </item>
</layer-list>
```
ç¬¬äºŒä¸ªæ›´ç®€å• - åªæ˜¯ç®€å•çš„åœ†å½¢ç”»ç¬”ï¼ˆå†…éƒ¨å›¾åƒåœ¨é¡¹ç›®èµ„æºä¸­æä¾›ï¼‰ã€‚
```xml
<?xml version="1.0" encoding="utf-8"?>
<!--btn_capture_options.xml-->
<shape xmlns:android="http://schemas.android.com/apk/res/android"
    android:shape="oval">
    <stroke
        android:width="1dp"
        android:color="#ffffff"
        android:dashWidth="0dp" />
</shape>
```
è¯·è®°ä½ï¼Œä»–ä»¬éƒ½ä¸å¤„ç† onClick å’Œå¯ç”¨/ç¦ç”¨çŠ¶æ€ã€‚ä½ å¯ä»¥è‡ªå·±åšã€‚ ğŸ˜„

ç°åœ¨æˆ‘ä»¬æœ‰äº† TakePhotoActivity å¸ƒå±€æ‰€éœ€çš„æ‰€æœ‰å…ƒç´ ã€‚å®ç°å¾ˆç®€å•ï¼Œä½†æœ‰ç‚¹å¤æ‚ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä¸æ˜¾ç¤ºæºä»£ç ã€‚è¿™é‡Œæ˜¯å®ƒçš„å¸ƒå±€çš„å¯è§†åŒ–:

![](http://frogermcs.github.io/images/9/take_photo_layout.png)
é¡¶éƒ¨å’Œåº•éƒ¨é¢æ¿ä»å±å¹•çš„å³ä¾§æ»‘åŠ¨ï¼ˆæ„Ÿè°¢ ViewSwitcher çˆ¶é¡¹ï¼‰ã€‚æ‹æ‘„ç…§ç‰‡æ—¶ï¼Œæ‹æ‘„çš„å›¾åƒï¼ˆå³ä¾§çš„ç™½è‰²æ–¹å—ï¼‰å‡ºç°åœ¨ CameraView çš„é¡¶éƒ¨ã€‚

è¿™é‡Œæ˜¯ .xml æ–‡ä»¶çš„[å®Œæ•´æºä»£ç ](https://github.com/frogermcs/InstaMaterial/blob/884b6b3219fc8175a1db364135926efd482bf2c4/app/src/main/res/layout/activity_take_photo.xml)ã€‚

## ç…§ç‰‡æ•æ‰è§†å›¾å®ç°
æœ€åï¼Œæˆ‘ä»¬å¯ä»¥å®ç°æœ€é‡è¦çš„äº‹æƒ…â€”â€”æ‹ç…§ã€‚ ç®€è€Œè¨€ä¹‹ï¼Œè¿™é‡Œåˆ—å‡ºäº†ä¸€ç³»åˆ—è¦æ±‚:

- ä»‹ç»åŠ¨ç”»ï¼ˆåœ¨åå°æ˜¾ç¤ºåŠ¨ç”»ä¹‹åç«‹å³æ»‘å…¥é¡¶éƒ¨å’Œåº•éƒ¨é¢æ¿ï¼‰
- ä»ç›¸æœºæ•æ‰ç…§ç‰‡
- ä¸¤ç§çŠ¶æ€ä¹‹é—´çš„åŠ¨ç”» - æ•æ‰å’Œç¼–è¾‘ç…§ç‰‡

ç¬¬ä¸€ç‚¹éå¸¸ç®€å•ã€‚åªéœ€éšè— Acitivity start çš„é¡¶éƒ¨å’Œåº•éƒ¨é¢æ¿ï¼Œå¹¶åœ¨èƒŒæ™¯æ˜¾ç¤ºåŠ¨ç”»ç»“æŸæ—¶æ˜¾ç¤ºå®ƒä»¬ï¼š
```java
public class TakePhotoActivity extends BaseActivity implements RevealBackgroundView.OnStateChangeListener {

    @InjectView(R.id.vUpperPanel)
    ViewSwitcher vUpperPanel;
    @InjectView(R.id.vLowerPanel)
    ViewSwitcher vLowerPanel;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        
        //...
        
        vUpperPanel.getViewTreeObserver().addOnPreDrawListener(new ViewTreeObserver.OnPreDrawListener() {
            @Override
            public boolean onPreDraw() {
                vUpperPanel.getViewTreeObserver().removeOnPreDrawListener(this);
                vUpperPanel.setTranslationY(-vUpperPanel.getHeight());
                vLowerPanel.setTranslationY(vLowerPanel.getHeight());
                return true;
            }
        });
    }

    @Override
    public void onStateChange(int state) {
        if (RevealBackgroundView.STATE_FINISHED == state) {
            vTakePhotoRoot.setVisibility(View.VISIBLE);
            startIntroAnimation();
        } else {
            vTakePhotoRoot.setVisibility(View.INVISIBLE);
        }
    }

    private void startIntroAnimation() {
        vUpperPanel.animate().translationY(0).setDuration(400).setInterpolator(DECELERATE_INTERPOLATOR);
        vLowerPanel.animate().translationY(0).setDuration(400).setInterpolator(DECELERATE_INTERPOLATOR).start();
    }

    //...
}
```

## ç…§ç‰‡æ•æ‰
ç°åœ¨æˆ‘ä»¬å¿…é¡»é…ç½® CameraViewã€‚æ ¹æ®[CWAC-Cameraæ–‡æ¡£](https://github.com/commonsguy/cwac-camera)ï¼Œæˆ‘ä»¬å¿…é¡»å°†è¿™ä¸ªè§†å›¾çš„æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸï¼ˆonResume () å’Œ onPause () æ–¹æ³•ï¼‰ç»“åˆèµ·æ¥ï¼š
```java
@Override
protected void onResume() {
    super.onResume();
    cameraView.onResume();
}

@Override
protected void onPause() {
    super.onPause();
    cameraView.onPause();
}
```
å¦‚æœæˆ‘ä»¬åœ¨å¸ƒå±€ä¸­ä½¿ç”¨ CameraViewï¼ˆè€Œä¸æ˜¯ä½¿ç”¨ CameraFragmentï¼‰ï¼Œæˆ‘ä»¬çš„ Activity å¿…é¡»å®ç°CameraHostProvider æ¥å£ã€‚ å®ƒæä¾›äº†åº”è¯¥è¿”å› CameraHost å®ç°çš„ getCameraHost () æ–¹æ³•ã€‚ è¿™ä¸ªæ¥å£å¯ä»¥ä¸ºæˆ‘ä»¬çš„ç›¸æœºé…ç½®é‡æ–°è®¾ç½®ã€‚ ä¸ºäº†æˆ‘ä»¬çš„éœ€è¦ï¼Œæˆ‘ä»¬åˆ›å»ºäº†éå¸¸ç®€å•çš„ MyCameraHost å†…éƒ¨ç±»ï¼š

```java
class MyCameraHost extends SimpleCameraHost {

    private Camera.Size previewSize;

    public MyCameraHost(Context ctxt) {
        super(ctxt);
    }

    @Override
    public boolean useFullBleedPreview() {
        return true;
    }

    @Override
    public Camera.Size getPictureSize(PictureTransaction xact, Camera.Parameters parameters) {
        return previewSize;
    }

    @Override
    public Camera.Parameters adjustPreviewParameters(Camera.Parameters parameters) {
        Camera.Parameters parameters1 = super.adjustPreviewParameters(parameters);
        previewSize = parameters1.getPreviewSize();
        return parameters1;
    }

    @Override
    public void saveImage(PictureTransaction xact, final Bitmap bitmap) {
        runOnUiThread(new Runnable() {
            @Override
            public void run() {
                showTakenPicture(bitmap);
            }
        });
    }
}
```
ç®€è€Œè¨€ä¹‹ï¼Œå°†ç›¸åŒçš„å¤§å°é¢„è§ˆå’Œæ•è·çš„å›¾åƒéœ€è¦æ³¨æ„ï¼ˆç”±äºæ‰€æ‹æ‘„çš„å›¾åƒä¸ä¼šè¢«æ‹‰ä¼¸ï¼Œæ¯”é¢„è§ˆï¼‰ã€‚ useFullBleedPreview () ä¸ ImageView ä¸­çš„ centerCrop ç¼©æ”¾ç±»å‹å‡ ä¹ç›¸åŒã€‚ å› æ­¤ï¼Œå¦‚æœ CameraView é¢„è§ˆå…·æœ‰ä¸è§†å›¾å¸ƒå±€å‚æ•°ä¸åŒçš„å¤§å°ï¼ˆåœ¨æˆ‘ä»¬çš„ç¤ºä¾‹ä¸­å®ƒå…·æœ‰ï¼ï¼‰ï¼Œé¢„è§ˆå°†è¢«è£å‰ªå¹¶å¡«å……æ•´ä¸ªå¯ç”¨åŒºåŸŸã€‚
 saveImageï¼ˆï¼‰æ–¹æ³•åœ¨æ•è·æ“ä½œç»“æŸæ—¶è¢«è°ƒç”¨ï¼ˆæ‰€ä»¥å³ä½¿æˆ‘ä»¬ä¿®æ”¹äº†ç»™å®šçš„ä½å›¾ï¼Œä¹Ÿä¸ä¼šå½±å“ä¿å­˜åœ¨æ‰‹æœºå†…å­˜ä¸Šçš„æ–‡ä»¶ï¼‰ã€‚ ä½†è¯·è®°ä½ï¼Œåªæœ‰å½“æˆ‘ä»¬ç”¨é€‚å½“çš„å‚æ•°è°ƒç”¨ takePicture () æ—¶ï¼Œæ‰ä¼šè°ƒç”¨ saveImage () æ–¹æ³•ã€‚

æˆ‘ä¸ä¼šæ·±å…¥ CameraHost å®æ–½çš„å…¶ä½™éƒ¨åˆ†ã€‚åªéœ€æ£€æŸ¥ CWAC-Camera æ–‡æ¡£ä»¥è·å–æ›´å¤šä¿¡æ¯ã€‚

æˆ‘ä»¬ç°åœ¨è¦åšçš„å°±æ˜¯è°ƒç”¨ takePicture () æ–¹æ³•ã€‚ å®ƒæœ‰ä¸¤ä¸ªå¸ƒå°”å‚æ•°ï¼šneedBitmap å’Œ needByteArrayã€‚ å¦‚æœç¬¬ä¸€ä¸ªè®¾ç½®ä¸º trueï¼Œåˆ™å°†åœ¨æˆ‘ä»¬çš„ CameraHost å®ç°ä¸­è°ƒç”¨ saveImageï¼ˆPictureTransaction xactï¼Œfinal Bitmapï¼‰ã€‚ ç¬¬äºŒæ¬¡è°ƒç”¨ saveImageï¼ˆPictureTransaction xactï¼Œbyte [] imageï¼‰ã€‚

å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³çœ‹åˆ°å¿«é—¨æ•ˆåº”ï¼Œæˆ‘ä»¬å¿…é¡»è‡ªå·±å®ç°ã€‚è¿™æ˜¯å®ƒåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­çš„æ ·å­ï¼š
```java
public class TakePhotoActivity extends BaseActivity implements RevealBackgroundView.OnStateChangeListener,
        CameraHostProvider {

    //...
    
    @OnClick(R.id.btnTakePhoto)
    public void onTakePhotoClick() {
        btnTakePhoto.setEnabled(false);
        cameraView.takePicture(true, false);
        animateShutter();
    }

    private void animateShutter() {
        vShutter.setVisibility(View.VISIBLE);
        vShutter.setAlpha(0.f);

        ObjectAnimator alphaInAnim = ObjectAnimator.ofFloat(vShutter, "alpha", 0f, 0.8f);
        alphaInAnim.setDuration(100);
        alphaInAnim.setStartDelay(100);
        alphaInAnim.setInterpolator(ACCELERATE_INTERPOLATOR);

        ObjectAnimator alphaOutAnim = ObjectAnimator.ofFloat(vShutter, "alpha", 0.8f, 0f);
        alphaOutAnim.setDuration(200);
        alphaOutAnim.setInterpolator(DECELERATE_INTERPOLATOR);

        AnimatorSet animatorSet = new AnimatorSet();
        animatorSet.playSequentially(alphaInAnim, alphaOutAnim);
        animatorSet.addListener(new AnimatorListenerAdapter() {
            @Override
            public void onAnimationEnd(Animator animation) {
                vShutter.setVisibility(View.GONE);
            }
        });
        animatorSet.start();
    }

    //...
}
```
è€Œæœ€åä¸€ä»¶äº‹ - æˆ‘ä»¬åº”è¯¥å¤„ç†æ‹ç…§å¹¶æ˜¾ç¤ºã€‚ åœ¨æˆ‘ä»¬çš„ä¾‹å­ä¸­ï¼Œå®ƒä»¥è¿™ç§æ–¹å¼å·¥ä½œï¼šåœ¨ CameraView ä¹‹ä¸Šï¼Œæˆ‘ä»¬éšè—äº† ImageViewã€‚ å¦‚æœåªæœ‰æˆ‘ä»¬ä» saveImage () æ–¹æ³•è·å¾—æ–°çš„ä½å›¾ï¼Œæˆ‘ä»¬æŠŠå®ƒæ”¾åˆ° ImageView ä¸­ï¼Œå¹¶æ˜¾ç¤ºåœ¨ CameraView çš„é¡¶éƒ¨ã€‚ æŒ‰ä¸‹åï¼ŒImageView è¢«éšè—ï¼Œç”¨æˆ·å¯ä»¥å†æ¬¡çœ‹åˆ° CameraViewã€‚ ä»¥ä¸‹æ˜¯æˆ‘ä»¬ä»£ç ä¸­çš„å¤–è§‚ï¼š
```java
public class TakePhotoActivity extends BaseActivity implements RevealBackgroundView.OnStateChangeListener,
        CameraHostProvider {
    
    //...

    private void showTakenPicture(Bitmap bitmap) {
        vUpperPanel.showNext();
        vLowerPanel.showNext();
        ivTakenPhoto.setImageBitmap(bitmap);
        updateState(STATE_SETUP_PHOTO);
    }

    @Override
    public void onBackPressed() {
        if (currentState == STATE_SETUP_PHOTO) {
            btnTakePhoto.setEnabled(true);
            vUpperPanel.showNext();
            vLowerPanel.showNext();
            updateState(STATE_TAKE_PHOTO);
        } else {
            super.onBackPressed();
        }
    }

    private void updateState(int state) {
        currentState = state;
        if (currentState == STATE_TAKE_PHOTO) {
            vUpperPanel.setInAnimation(this, R.anim.slide_in_from_right);
            vLowerPanel.setInAnimation(this, R.anim.slide_in_from_right);
            vUpperPanel.setOutAnimation(this, R.anim.slide_out_to_left);
            vLowerPanel.setOutAnimation(this, R.anim.slide_out_to_left);
            new Handler().postDelayed(new Runnable() {
                @Override
                public void run() {
                    ivTakenPhoto.setVisibility(View.GONE);
                }
            }, 400);
        } else if (currentState == STATE_SETUP_PHOTO) {
            vUpperPanel.setInAnimation(this, R.anim.slide_in_from_left);
            vLowerPanel.setInAnimation(this, R.anim.slide_in_from_left);
            vUpperPanel.setOutAnimation(this, R.anim.slide_out_to_right);
            vLowerPanel.setOutAnimation(this, R.anim.slide_out_to_right);
            ivTakenPhoto.setVisibility(View.VISIBLE);
        }
    }
}
```
è¿™é‡Œæ˜¯ [TakePhotoActivity](https://github.com/frogermcs/InstaMaterial/blob/29dfdc0ae8ff74d3508f9ae84bbec8cb22c80223/app/src/main/java/io/github/froger/instamaterial/ui/activity/TakePhotoActivity.java) çš„å®Œæ•´æºä»£ç ã€‚

è€Œä»Šå¤©å°±æ˜¯è¿™æ ·ã€‚è°¢è°¢å¤§å®¶çš„é˜…è¯»ï¼ ğŸ˜„

## ç¤ºä¾‹ä»£ç 
 æ‰€æè¿°é¡¹ç›®çš„å®Œæ•´æºä»£ç åœ¨ Github [å­˜å‚¨åº“](https://github.com/frogermcs/InstaMaterial)ä¸Šå¯ç”¨ã€‚




